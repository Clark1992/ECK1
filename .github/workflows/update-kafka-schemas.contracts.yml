name: Upload Schemas

permissions:
  contents: write
  packages: read

on:
  workflow_run:
    workflows: ["Publish ECK1.Contracts"] 
    types:
      - completed
  push:
    branches: [ "main" ]
    paths:
      - '.github/workflows/update-kafka-schemas.contracts.yml'
      - '.github/workflows/actions/run-generator/action.yml'
      - '.github/workflows/actions/download-secrets/action.yml'
      - '.github/workflows/actions/run-generator/schema-gen-job-params.json'


jobs:
  generate-schemas:
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      SOLUTION_DIR: src

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download secrets
        uses: ./.github/workflows/actions/download-secrets
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}
          project: eck1-global
          config: dev

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Download latest NuGet package
        shell: bash
        run: |
          PACKAGE_NAME="ECK1.Contracts"
          OWNER="${GITHUB_REPOSITORY_OWNER}"

          SERVICE_INDEX=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/json" \
            "https://nuget.pkg.github.com/${OWNER}/index.json")

          PACKAGE_BASE_URL=$(echo "$SERVICE_INDEX" | jq -r '.resources[] | select(.["@type"]=="PackageBaseAddress/3.0.0") | .["@id"]')

          if [ -z "$PACKAGE_BASE_URL" ]; then
            echo "Cannot find PackageBaseAddress in feed"
            exit 1
          fi

          VERSIONS_JSON=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/json" \
            "$PACKAGE_BASE_URL/$PACKAGE_NAME/index.json")

          if [ -z "$VERSIONS_JSON" ]; then
            echo "Cannot get versions for package $PACKAGE_NAME"
            exit 1
          fi

          echo "Versions JSON: $VERSIONS_JSON"

          PACKAGE_VERSION=$(echo "$VERSIONS_JSON" | jq -r '.versions[]' | sort -V | tail -n1)
          echo "Latest version: $PACKAGE_VERSION"

          NUPKG_PATH="/tmp/${PACKAGE_NAME}.nupkg"
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/octet-stream" \
            -o "$NUPKG_PATH" \
            "$PACKAGE_BASE_URL/$PACKAGE_NAME/$PACKAGE_VERSION/$PACKAGE_NAME.$PACKAGE_VERSION.nupkg"

          echo "$PACKAGE_BASE_URL/$PACKAGE_NAME/$PACKAGE_VERSION/$PACKAGE_NAME.$PACKAGE_VERSION.nupkg"

          echo "Downloaded package to $NUPKG_PATH"

          DLL_DIR="/tmp/${PACKAGE_NAME}_dll"
          mkdir -p "$DLL_DIR"
          unzip -o "$NUPKG_PATH" "lib/net8.0/*.dll" -d "$DLL_DIR"

          ##########################
          DLL_PATH=$(find /tmp/${PACKAGE_NAME}_dll -type f -name "${PACKAGE_NAME}.dll" | sort -r | head -n 1)
          echo "Found DLL at $DLL_PATH"

          echo "ASSEMBLY_PATH=$DLL_PATH" >> $GITHUB_ENV

      - name: Run generator
        uses: ./.github/workflows/actions/run-generator
        with:
          assembly-path: ${{ env.ASSEMBLY_PATH }}
          solution-dir: ${{ env.SOLUTION_DIR }}
          solution-file: ECK1.sln

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "Update kafka schemas"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
