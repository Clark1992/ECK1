name: Generate Kafka Schemas

permissions:
  contents: write
  packages: read

on:
  workflow_dispatch: {}
  workflow_run:
    workflows: ["Publish ECK1.Contracts", "Publish ECK1.IntegrationContracts"] 
    types:
      - completed
  push:
    branches: [ "main" ]
    paths:
      - '.github/workflows/update-kafka-schemas.contracts.yml'
      - '.github/workflows/actions/run-generator/action.yml'
      - '.github/workflows/actions/download-secrets/action.yml'
      - '.github/workflows/actions/run-generator/schema-gen-job-params.json'

jobs:
  generate-schemas:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest

    env:
      SOLUTION_DIR: src

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download secrets
        uses: ./.github/workflows/actions/download-secrets
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}
          project: eck1-global
          config: dev

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Download NuGet packages
        shell: bash
        run: |
          set -e

          OWNER="${GITHUB_REPOSITORY_OWNER}"

          declare -A PACKAGES=(
            [ECK1.Contracts]=BUSINESS_CONTRACTS_ASSEMBLY_PATH
            [ECK1.IntegrationContracts]=INTEGRATION_CONTRACTS_ASSEMBLY_PATH
          )

          SERVICE_INDEX=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/json" \
            "https://nuget.pkg.github.com/${OWNER}/index.json")

          PACKAGE_BASE_URL=$(echo "$SERVICE_INDEX" | jq -r \
            '.resources[] | select(.["@type"]=="PackageBaseAddress/3.0.0") | .["@id"]')

          if [ -z "$PACKAGE_BASE_URL" ]; then
            echo "Cannot find PackageBaseAddress in feed"
            exit 1
          fi

          for PACKAGE_NAME in "${!PACKAGES[@]}"; do
            ENV_NAME="${PACKAGES[$PACKAGE_NAME]}"

            echo "Processing $PACKAGE_NAME â†’ $ENV_NAME"

            VERSIONS_JSON=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/json" \
              "$PACKAGE_BASE_URL/$PACKAGE_NAME/index.json")

            if [ -z "$VERSIONS_JSON" ]; then
              echo "Cannot get versions for package $PACKAGE_NAME"
              exit 1
            fi

            echo "Versions JSON: $VERSIONS_JSON"

            PACKAGE_VERSION=$(echo "$VERSIONS_JSON" | jq -r '.versions[]' | sort -V | tail -n1)
            echo "Latest version: $PACKAGE_VERSION"

            NUPKG_PATH="/tmp/${PACKAGE_NAME}.nupkg"
            curl -L \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/octet-stream" \
              -o "$NUPKG_PATH" \
              "$PACKAGE_BASE_URL/$PACKAGE_NAME/$PACKAGE_VERSION/$PACKAGE_NAME.$PACKAGE_VERSION.nupkg"

            echo "$PACKAGE_BASE_URL/$PACKAGE_NAME/$PACKAGE_VERSION/$PACKAGE_NAME.$PACKAGE_VERSION.nupkg"

            echo "Downloaded package to $NUPKG_PATH"

            DLL_DIR="/tmp/${PACKAGE_NAME}_dll"
            mkdir -p "$DLL_DIR"
            unzip -o "$NUPKG_PATH" "lib/net8.0/*.dll" -d "$DLL_DIR"

            ##########################
            DLL_PATH=$(find "$DLL_DIR" -type f -name "${PACKAGE_NAME}.dll" | sort -r | head -n 1)
            echo "Found DLL at $DLL_PATH"

            echo "$ENV_NAME=$DLL_PATH" >> $GITHUB_ENV
          done

      - name: Run generator
        uses: ./.github/workflows/actions/run-generator
        with:
          business-contracts-assembly-path: ${{ env.BUSINESS_CONTRACTS_ASSEMBLY_PATH }}
          integration-contracts-assembly-path: ${{ env.INTEGRATION_CONTRACTS_ASSEMBLY_PATH }}
          solution-dir: ${{ env.SOLUTION_DIR }}
          solution-file: ECK1.sln

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "Update kafka schemas"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
